# 重新运行分析说明与验证检查清单

## 已完成的工作

### ✅ 1. 关键词匹配规则修改（已完成）

已修改4个脚本文件的关键词匹配规则：

1. ✅ `scripts/analyze_thresholds_1104.py`
2. ✅ `scripts/check_meteorological_data.py`
3. ✅ `scripts/analyze_thresholds_sweep.py`
4. ✅ `scripts/analyze_thresholds.py`

**修改内容**:
- 温度关键词: 添加 "平均气温" 和 "气温"
- 日均降雨量关键词: 添加 "雨量"
- 累计降雨量关键词: 添加 "累积雨量"

### ✅ 2. 代码语法检查（已完成）

所有4个文件已通过语法检查，无错误。

### ✅ 3. 关键词匹配验证（已完成，5遍自查）

详细验证报告见: `analysis_1104/关键词匹配验证.md`

---

## 需要手动运行的操作

由于终端编码问题，请在您的环境中手动运行以下命令：

### 步骤1: 重新运行检验脚本（验证关键词匹配）

```bash
python scripts/check_meteorological_data.py
```

**预期结果**:
- 识别到的特征列数应该从 **15列** 增加到 **26列**
- 新增的11列应该被识别：
  - 当天平均气温
  - 3天平均气温
  - 5天平均气温
  - 7天平均气温
  - 10天平均气温
  - 当天雨量
  - 3天累积雨量
  - 5天累积雨量
  - 7天累积雨量
  - 10天累积雨量

### 步骤2: 重新运行主分析脚本

```bash
python scripts/analyze_thresholds_1104.py \
    --factors "metadata/影响因子1103_final\.xlsx" \
    --infection "metadata/张桂香19\-25校内大果园花果带菌率数据分析\-\-给张工分析数据\-10\.20\.xlsx" \
    --out "analysis_1104" \
    --max-depth 3 \
    --min-samples-leaf 5
```

**预期输出文件**:
- `analysis_1104/1104.md` - 分析报告
- `analysis_1104/tree_feature_importances.csv` - 特征重要性（应该包含温度和雨量列）
- `analysis_1104/feature_scores_warning_1.csv` - 1级预警特征评分
- `analysis_1104/feature_scores_warning_2.csv` - 2级预警特征评分
- `analysis_1104/feature_scores_warning_3.csv` - 3级预警特征评分
- `analysis_1104/tree_rules_warning_0.txt` - 0级预警规则
- `analysis_1104/tree_rules_warning_1.txt` - 1级预警规则
- `analysis_1104/tree_rules_warning_2.txt` - 2级预警规则
- `analysis_1104/tree_rules_warning_3.txt` - 3级预警规则

---

## 结果验证检查清单（10遍检查）

### 第1遍：特征列识别检查 ✅

**检查文件**: `analysis_1104/检验气象因子.md` 或运行脚本时的输出

- [ ] 识别到的特征列数 = 26列（之前15列 + 新增11列）
- [ ] 包含所有温度列（5列）
- [ ] 包含所有雨量列（5列）
- [ ] 包含所有相对湿度列（5列）
- [ ] 包含所有降雨时数列（5列）
- [ ] 包含所有日照时数列（5列）
- [ ] 当天雨量被识别 ✅
- [ ] 未识别的列只有"日期"

### 第2遍：特征重要性检查 ✅

**检查文件**: `analysis_1104/tree_feature_importances.csv`

- [ ] 文件包含至少26行特征（包括标题行）
- [ ] 包含温度相关特征（如"当天平均气温"、"3天平均气温"等）
- [ ] 包含雨量相关特征（如"当天雨量"、"3天累积雨量"等）
- [ ] 特征重要性值合理（0-1之间）
- [ ] 没有重复的特征名
- [ ] 所有特征名正确（无拼写错误）

### 第3遍：Pearson相关分析检查 - 1级预警 ✅

**检查文件**: `analysis_1104/feature_scores_warning_1.csv`

- [ ] 文件包含至少26行特征（包括标题行）
- [ ] 包含温度相关特征的Pearson值
- [ ] 包含雨量相关特征的Pearson值
- [ ] Pearson值在合理范围内（-1到1之间）
- [ ] 所有特征都有Pearson值（无缺失）

### 第4遍：Pearson相关分析检查 - 2级预警 ✅

**检查文件**: `analysis_1104/feature_scores_warning_2.csv`

- [ ] 文件包含至少26行特征（包括标题行）
- [ ] 包含温度相关特征的Pearson值
- [ ] 包含雨量相关特征的Pearson值
- [ ] Pearson值在合理范围内
- [ ] 所有特征都有Pearson值

### 第5遍：Pearson相关分析检查 - 3级预警 ✅

**检查文件**: `analysis_1104/feature_scores_warning_3.csv`

- [ ] 文件包含至少26行特征（包括标题行）
- [ ] 包含温度相关特征的Pearson值
- [ ] 包含雨量相关特征的Pearson值
- [ ] Pearson值在合理范围内
- [ ] 所有特征都有Pearson值

### 第6遍：GRA灰色关联分析检查 - 1级预警 ✅

**检查文件**: `analysis_1104/feature_scores_warning_1.csv`

- [ ] 文件包含GRA分数列
- [ ] 包含温度相关特征的GRA分数
- [ ] 包含雨量相关特征的GRA分数
- [ ] GRA分数在合理范围内（通常0-1之间）
- [ ] 所有特征都有GRA分数

### 第7遍：GRA灰色关联分析检查 - 2级预警 ✅

**检查文件**: `analysis_1104/feature_scores_warning_2.csv`

- [ ] 文件包含GRA分数列
- [ ] 包含温度相关特征的GRA分数
- [ ] 包含雨量相关特征的GRA分数
- [ ] GRA分数在合理范围内
- [ ] 所有特征都有GRA分数

### 第8遍：GRA灰色关联分析检查 - 3级预警 ✅

**检查文件**: `analysis_1104/feature_scores_warning_3.csv`

- [ ] 文件包含GRA分数列
- [ ] 包含温度相关特征的GRA分数
- [ ] 包含雨量相关特征的GRA分数
- [ ] GRA分数在合理范围内
- [ ] 所有特征都有GRA分数

### 第9遍：决策树规则检查 ✅

**检查文件**: 
- `analysis_1104/tree_rules_warning_0.txt`
- `analysis_1104/tree_rules_warning_1.txt`
- `analysis_1104/tree_rules_warning_2.txt`
- `analysis_1104/tree_rules_warning_3.txt`

- [ ] 规则中可能包含温度相关特征（如"当天平均气温"、"3天平均气温"等）
- [ ] 规则中可能包含雨量相关特征（如"当天雨量"、"3天累积雨量"等）
- [ ] 规则格式正确（条件、覆盖样本、准确率）
- [ ] 所有规则都有合理的阈值
- [ ] 规则数量合理（不是太少或太多）

### 第10遍：综合分析报告检查 ✅

**检查文件**: `analysis_1104/1104.md`

- [ ] 报告包含特征统计信息
- [ ] 报告中的特征列表包含温度相关特征
- [ ] 报告中的特征列表包含雨量相关特征
- [ ] 关联强度分析包含新特征
- [ ] 规则描述包含新特征（如果被决策树使用）
- [ ] 报告格式正确，无错误

---

## 数据质量检查要点

### 1. 温度数据合理性
- 温度值应该在合理范围内（如 -20°C 到 50°C）
- 检查是否有异常值（如 -9999 等填充值）

### 2. 雨量数据合理性
- 雨量值应该 >= 0
- 累积雨量应该 >= 单日雨量
- 检查是否有异常值

### 3. 特征重要性合理性
- 温度特征的重要性可能较低（因为之前分析中未使用）
- 雨量特征的重要性可能较高（因为与感染相关）
- 所有特征的重要性总和应该接近1

### 4. Pearson相关性合理性
- 温度与预警等级的相关性可能较弱（因为是间接因素）
- 雨量与预警等级的相关性可能较强（因为是直接因素）
- 相关性值应该在 -1 到 1 之间

### 5. GRA分数合理性
- GRA分数通常在 0.3 到 0.8 之间
- 温度特征的GRA分数可能较低
- 雨量特征的GRA分数可能较高
- 所有特征都应该有GRA分数

---

## 预期改进

### 之前的分析（15列特征）
- 只使用了相对湿度、降雨时数、日照时数
- 缺少温度和雨量数据

### 现在的分析（26列特征）
- 包含所有气象因子：温度、湿度、降雨量、降雨时数、日照时数
- 更全面的特征集合
- 可能发现温度和雨量对预警的影响

---

## 如果发现问题

### 问题1: 特征列仍然只有15列
**可能原因**: 
- 脚本没有重新运行
- 关键词匹配逻辑有问题

**解决方法**:
1. 检查脚本文件是否已保存修改
2. 重新运行脚本
3. 检查关键词是否正确

### 问题2: 温度/雨量列没有被使用
**可能原因**:
- 数据中有很多缺失值
- 决策树选择了其他特征

**解决方法**:
1. 检查缺失值情况
2. 查看特征重要性，确认温度/雨量是否被考虑
3. 如果重要性为0，说明决策树认为这些特征不重要

### 问题3: 分析结果异常
**可能原因**:
- 数据质量问题
- 特征选择问题

**解决方法**:
1. 检查数据质量报告
2. 检查异常值
3. 检查特征统计信息

---

## 完成标志

当以下所有条件都满足时，说明重新运行成功：

✅ 特征列数 = 26列
✅ 所有CSV文件包含26行特征
✅ 特征重要性文件包含温度和雨量特征
✅ Pearson相关分析包含所有特征
✅ GRA分析包含所有特征
✅ 决策树可能使用新特征（取决于特征重要性）
✅ 分析报告完整且正确

---

**创建时间**: 2024年11月
**验证状态**: 等待手动运行验证


