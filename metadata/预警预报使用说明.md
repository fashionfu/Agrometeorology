# 荔枝霜疫霉预警预报使用说明

## 概述

本说明文档介绍如何使用训练好的决策树模型，根据当天的气象数据预测荔枝霜疫霉预警等级。

## 核心要点

### ⚠️ 重要提示

**不能直接使用规则进行判断！** 

规则（如"10天累积雨量 ≤ 19.500 且 当天相对湿度 ≤ 74.500"）只是描述模型判断逻辑的参考，不能直接用于预测。

**应该使用完整的决策树模型进行预测！**

## 使用方法

### 方法1：使用预测脚本（推荐）

#### 1. 首次使用：训练并保存模型

```bash
python scripts/predict_warning.py --factors "metadata/影响因子1103_final\.csv" --warning "metadata/张桂香19\-25校内大果园花果带菌率数据分析\-\-给张工分析数据\-10\.20_预警\.xlsx" --model "models/warning_model.pkl"
```

这会：
- 读取训练数据
- 训练决策树模型
- 保存模型到 `models/warning_model.pkl`

#### 2. 进行预测

**方式A：从Excel/CSV文件批量预测**

```bash
python scripts/predict_warning.py --predict "当天气象数据.xlsx" --output "预测结果.xlsx" --model "models/warning_model.pkl"
```

**方式B：在Python代码中使用**

```python
import pickle
from scripts.predict_warning import predict_warning_level

# 加载模型
with open('models/warning_model.pkl', 'rb') as f:
    model_data = pickle.load(f)

# 准备当天的气象数据
weather_data = {
    '10天累积雨量': 15.5,
    '当天相对湿度': 72.3,
    '10天累积日照时数': 35.2,
    '当天平均气温': 24.5,
    # ... 其他必需的气象因子
}

# 预测预警等级
level, level_name = predict_warning_level(model_data, weather_data)
print(f"预测预警等级: {level_name}")
```

### 方法2：使用改善版.md中的规则（仅作参考，不推荐）

如果您**必须**使用规则进行快速判断，可以参考以下方式：

**注意：这种方式准确性较低，仅适用于快速参考，不适用于正式预报！**

#### 使用建议

1. **多个规则综合判断**
   - 不要只使用一个规则
   - 检查样本是否匹配多个规则
   - 如果匹配多个规则的预警等级不一致，需要结合其他信息判断

2. **规则优先级**
   - 优先使用准确率高、覆盖样本多的规则
   - 参考 `改善版.md` 中"最优规则"的建议

3. **示例判断流程**

```python
# 伪代码示例（不完整，仅供参考）
def quick_reference_judge(weather_data):
    rules_matched = []
    
    # 检查规则1：1级预警
    if (weather_data['10天累积雨量'] <= 19.5 and 
        weather_data['当天相对湿度'] <= 74.5):
        rules_matched.append(1)
    
    # 检查规则2：2级预警
    if (weather_data['10天累积雨量'] > 19.5 and 
        weather_data['10天累积日照时数'] > 24.85 and
        weather_data['10天累积日照时数'] <= 50.75):
        rules_matched.append(2)
    
    # 检查规则3：3级预警
    if (weather_data['10天累积雨量'] > 19.5 and 
        weather_data['10天累积日照时数'] <= 24.85 and
        weather_data['当天平均气温'] <= 23.05):
        rules_matched.append(3)
    
    # 如果只匹配一个规则，返回该等级
    if len(set(rules_matched)) == 1:
        return rules_matched[0]
    
    # 如果匹配多个规则，返回最高等级（更保守）
    if rules_matched:
        return max(rules_matched)
    
    # 如果没有匹配任何规则，返回0级或需要人工判断
    return 0
```

**⚠️ 警告：上述方法仅供参考，准确性无法保证！**

## 推荐工作流程

### 日常预报流程

1. **准备当天气象数据**
   - 确保包含所有必需的气象因子（参考模型训练时使用的特征）
   - 数据格式：Excel或CSV文件

2. **运行预测脚本**
   ```bash
   python scripts/predict_warning.py --predict "当天气象数据.xlsx" --output "今日预警.xlsx"
   ```

3. **查看预测结果**
   - 查看输出的Excel文件中的"预测预警等级"列
   - 预警等级：0级（不发生）、1级（轻度）、2级（中度）、3级（重度）

4. **结合实际情况调整**
   - 模型预测结果应作为参考
   - 结合当地实际情况、历史经验等进行综合判断
   - 如有疑问，建议咨询专业技术人员

### 定期更新模型

建议定期（如每年）重新训练模型：
- 使用最新的数据重新训练
- 评估模型性能
- 更新模型文件

## 必需的气象因子

预测需要以下气象因子（具体名称可能会因数据文件而异）：

- **10天累积雨量**：过去10天的累积降雨量（mm）
- **当天相对湿度**：当天的平均相对湿度（%）
- **10天累积日照时数**：过去10天的累积日照时数（小时）
- **当天平均气温**：当天的平均气温（°C）
- **5天平均相对湿度**：过去5天的平均相对湿度（%）
- **3天累积降雨时数**：过去3天的累积降雨时数（小时）
- **7天累积日照时数**：过去7天的累积日照时数（小时）
- **5天累积雨量**：过去5天的累积雨量（mm）
- **当天降雨时数**：当天的降雨时数（小时）
- **10天平均相对湿度**：过去10天的平均相对湿度（%）

**注意**：具体需要哪些因子取决于模型训练时使用的特征。预测脚本会自动检查必需的因子。

## 常见问题

### Q1: 为什么不能直接用规则判断？

A: 决策树规则是路径规则，描述的是从根节点到叶子节点的完整判断路径。即使满足规则中的条件，样本也可能在决策树的其他分支被判断为不同的预警等级。

### Q2: 模型预测准确吗？

A: 模型在训练数据上的准确率约为82-92%（根据不同方案）。对于新数据，准确率可能会有所变化。建议：
- 定期验证模型预测结果
- 结合实际情况进行综合判断
- 根据使用反馈调整模型参数

### Q3: 如何使用不同方案的模型？

A: 可以通过 `--max_depth` 和 `--min_samples_leaf` 参数指定不同方案的参数：

```bash
# 方案一：depth4_leaf2
python scripts/predict_warning.py --model "models/model_depth4_leaf2.pkl" --max_depth 4 --min_samples_leaf 2 --predict "数据.xlsx"

# 方案二：depth4_leaf3
python scripts/predict_warning.py --model "models/model_depth4_leaf3.pkl" --max_depth 4 --min_samples_leaf 3 --predict "数据.xlsx"

# 方案三：depth7_leaf2
python scripts/predict_warning.py --model "models/model_depth7_leaf2.pkl" --max_depth 7 --min_samples_leaf 2 --predict "数据.xlsx"
```

### Q4: 缺少某些气象因子怎么办？

A: 如果缺少某些因子，可以：
1. 使用历史数据估算（如用最近的数据代替）
2. 使用插值方法估算
3. 重新训练模型（排除缺失的因子）

但需要注意，这可能会影响预测准确性。

## 技术支持

如有问题，请：
1. 检查数据格式是否正确
2. 确认包含所有必需的气象因子
3. 查看错误提示信息
4. 参考 `改善版.md` 中的详细规则说明

## 参考资料

- `analysis_1104_batch/改善版.md`：详细的规则说明和分析结果
- `scripts/predict_warning.py`：预测脚本源代码
- `scripts/analyze_thresholds_1104.py`：模型训练脚本源代码
