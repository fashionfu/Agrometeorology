# 预警等级判断逻辑详细说明

## 一、预警标准

根据感病率数据，预警等级判断标准如下：

1. **轻度（1级，不易发生）**：树下落地花果感病率 ≤ 10%，且树上感病率 = 0
2. **中度（2级，较易发生）**：树下落地花果感病率 > 10% 且 ≤ 40%，且树上感病率 = 0
3. **重度（3级，易发生）**：树下落地花果感病率 > 40%，且树上感病率 > 0

## 二、判断流程

### 2.1 判断流程图

```
开始判断
  ↓
读取数据：树下感病率(down_rate)、树上感病率(up_rate)
  ↓
检查数据有效性
  ├─ 如果 down_rate 或 up_rate 为 None/缺失 → 返回 None（无法判断）
  └─ 如果数据有效 → 继续判断
      ↓
【第一步】判断是否为轻度（1级）
  ├─ 条件：down_rate ≤ 10.0 且 up_rate == 0.0
  ├─ 满足 → 返回 1（轻度）
  └─ 不满足 → 继续判断
      ↓
【第二步】判断是否为中度（2级）
  ├─ 条件：10.0 < down_rate ≤ 40.0 且 up_rate == 0.0
  ├─ 满足 → 返回 2（中度）
  └─ 不满足 → 继续判断
      ↓
【第三步】判断是否为重度（3级）
  ├─ 条件：down_rate > 40.0 且 up_rate > 0.0
  ├─ 满足 → 返回 3（重度）
  └─ 不满足 → 返回 None（不符合任何标准）
```

### 2.2 判断逻辑代码

```python
def calculate_warning_level_from_infection_rate(down_rate, up_rate):
    """
    根据感病率计算预警等级
    
    参数:
        down_rate: 树下落地花果感病率（百分比，如 5.0 表示 5%）
        up_rate: 树上感病率（百分比，如 0.0 表示 0%）
    
    返回:
        1, 2, 3 或 None（如果不符合任何标准）
    """
    # 步骤1：检查数据有效性
    if down_rate is None or up_rate is None:
        return None
    
    # 转换为浮点数
    down_rate = float(down_rate)
    up_rate = float(up_rate)
    
    # 步骤2：判断轻度（1级）
    # 条件：树下≤10%，树上=0
    if down_rate <= 10.0 and up_rate == 0.0:
        return 1
    
    # 步骤3：判断中度（2级）
    # 条件：树下>10%且≤40%，树上=0
    if 10.0 < down_rate <= 40.0 and up_rate == 0.0:
        return 2
    
    # 步骤4：判断重度（3级）
    # 条件：树下>40%，树上>0
    if down_rate > 40.0 and up_rate > 0.0:
        return 3
    
    # 步骤5：不符合任何标准
    return None
```

## 三、所有可能的判断情况

### 3.1 完整判断情况表

| 情况编号 | 树下感病率 (down_rate) | 树上感病率 (up_rate) | 判断结果 | 说明 |
|---------|----------------------|---------------------|---------|------|
| 1 | ≤ 10.0 | = 0.0 | **1级（轻度）** | 符合轻度标准 |
| 2 | ≤ 10.0 | > 0.0 | **None** | 不符合任何标准（树下低但树上有感病） |
| 3 | > 10.0 且 ≤ 40.0 | = 0.0 | **2级（中度）** | 符合中度标准 |
| 4 | > 10.0 且 ≤ 40.0 | > 0.0 | **None** | 不符合任何标准（树下中等但树上有感病） |
| 5 | > 40.0 | = 0.0 | **None** | 不符合任何标准（树下高但树上无感病） |
| 6 | > 40.0 | > 0.0 | **3级（重度）** | 符合重度标准 |
| 7 | None/缺失 | 任意 | **None** | 数据缺失，无法判断 |
| 8 | 任意 | None/缺失 | **None** | 数据缺失，无法判断 |

### 3.2 边界值判断示例

| 示例 | 树下感病率 | 树上感病率 | 判断结果 | 判断依据 |
|------|-----------|-----------|---------|---------|
| 示例1 | 0.0% | 0.0% | **1级（轻度）** | down_rate ≤ 10.0 且 up_rate == 0.0 |
| 示例2 | 5.0% | 0.0% | **1级（轻度）** | down_rate ≤ 10.0 且 up_rate == 0.0 |
| 示例3 | 10.0% | 0.0% | **1级（轻度）** | down_rate ≤ 10.0 且 up_rate == 0.0 |
| 示例4 | 10.1% | 0.0% | **2级（中度）** | 10.0 < down_rate ≤ 40.0 且 up_rate == 0.0 |
| 示例5 | 25.0% | 0.0% | **2级（中度）** | 10.0 < down_rate ≤ 40.0 且 up_rate == 0.0 |
| 示例6 | 40.0% | 0.0% | **2级（中度）** | 10.0 < down_rate ≤ 40.0 且 up_rate == 0.0 |
| 示例7 | 40.1% | 0.0% | **None** | 不符合任何标准（树下>40%但树上=0） |
| 示例8 | 50.0% | 0.0% | **None** | 不符合任何标准（树下>40%但树上=0） |
| 示例9 | 40.1% | 0.1% | **3级（重度）** | down_rate > 40.0 且 up_rate > 0.0 |
| 示例10 | 50.0% | 5.0% | **3级（重度）** | down_rate > 40.0 且 up_rate > 0.0 |
| 示例11 | 5.0% | 1.0% | **None** | 不符合任何标准（树下≤10%但树上>0） |
| 示例12 | 25.0% | 1.0% | **None** | 不符合任何标准（树下10-40%但树上>0） |

## 四、实际数据处理流程

### 4.1 数据读取和处理步骤

1. **读取感病率数据**
   - 自动识别数据文件中的"树下感病率"列和"树上感病率"列
   - 将百分比字符串（如"5%"、"10.5%"）转换为数值（5.0、10.5）

2. **逐条判断预警等级**
   ```python
   for idx, row in df.iterrows():
       down_rate = row["树下感病率"]  # 例如：5.0
       up_rate = row["树上感病率"]    # 例如：0.0
       level = calculate_warning_level_from_infection_rate(down_rate, up_rate)
       # level 可能是 1, 2, 3 或 None
   ```

3. **处理无法判断的情况**
   - 如果根据感病率无法判断（返回 None），则回退到原始"预警"列的值
   - 如果原始预警为"未定义"，则排除该样本
   - 如果既没有有效感病率，也没有有效原始预警，则删除该样本

### 4.2 判断优先级

1. **第一优先级**：根据感病率判断（使用 `calculate_warning_level_from_infection_rate` 函数）
2. **第二优先级**：如果感病率判断返回 None，则使用原始"预警"列的值
3. **第三优先级**：如果原始预警为"未定义"或无效，则排除该样本

## 五、特殊情况说明

### 5.1 边界值处理

- **等于边界值的情况**：
  - `down_rate == 10.0` 且 `up_rate == 0.0` → **1级（轻度）**
  - `down_rate == 40.0` 且 `up_rate == 0.0` → **2级（中度）**
  - `down_rate == 40.0` 且 `up_rate > 0.0` → **3级（重度）**

- **严格不等号的使用**：
  - 轻度：`down_rate <= 10.0`（包含10.0）
  - 中度：`10.0 < down_rate <= 40.0`（不包含10.0，包含40.0）
  - 重度：`down_rate > 40.0`（不包含40.0）

### 5.2 树上感病率的作用

- **树上感病率 = 0**：这是判断轻度和中度的必要条件
- **树上感病率 > 0**：这是判断重度的必要条件，但如果树下感病率 ≤ 40%，则不符合任何标准

### 5.3 不符合标准的情况

以下情况会返回 None（不符合任何标准）：
1. 树下感病率 ≤ 10%，但树上感病率 > 0
2. 树下感病率在 10%-40% 之间，但树上感病率 > 0
3. 树下感病率 > 40%，但树上感病率 = 0

这些情况在实际数据中可能较少，如果出现，系统会回退到原始预警列的值。

## 六、实际数据示例

假设有以下数据：

| 日期 | 树下感病率 | 树上感病率 | 判断过程 | 判断结果 |
|------|-----------|-----------|---------|---------|
| 2024-03-01 | 5.0% | 0.0% | down_rate(5.0) ≤ 10.0 且 up_rate(0.0) == 0.0 → 满足轻度条件 | **1级（轻度）** |
| 2024-03-02 | 15.0% | 0.0% | down_rate(15.0) 在 10.0-40.0 之间 且 up_rate(0.0) == 0.0 → 满足中度条件 | **2级（中度）** |
| 2024-03-03 | 50.0% | 3.0% | down_rate(50.0) > 40.0 且 up_rate(3.0) > 0.0 → 满足重度条件 | **3级（重度）** |
| 2024-03-04 | 8.0% | 2.0% | down_rate(8.0) ≤ 10.0 但 up_rate(2.0) > 0.0 → 不符合任何标准 | **None**（回退到原始预警） |
| 2024-03-05 | 30.0% | 1.0% | down_rate(30.0) 在 10.0-40.0 之间 但 up_rate(1.0) > 0.0 → 不符合任何标准 | **None**（回退到原始预警） |
| 2024-03-06 | 45.0% | 0.0% | down_rate(45.0) > 40.0 但 up_rate(0.0) == 0.0 → 不符合任何标准 | **None**（回退到原始预警） |

## 七、总结

判断逻辑的核心是：
1. **先判断树上感病率是否为0**，这是区分轻/中度和重度的关键
2. **再判断树下感病率的范围**，确定是轻度还是中度
3. **树上感病率>0且树下感病率>40%**，才能判断为重度

这种判断逻辑确保了：
- 只有树上无感病时，才能判断为轻度或中度
- 只有树上和树下都有感病时，才能判断为重度
- 不符合标准的情况会回退到原始预警值，确保数据不丢失


